"use strict"

!(function ($) {

    //
    $.fn.dataTable.ext.errMode = 'none';

    // var Selector = {
    //     CONTROL_SIDEBAR: '#sidebar'
    // };
    // var Default = {
    //     scrollbarTheme: 'os-theme-light',
    //     scrollbarAutoHide: 'l'
    // };
    // // scrollbars on sidebar
    // if (typeof $.fn.overlayScrollbars !== 'undefined') {
    //     $(Selector.CONTROL_SIDEBAR).overlayScrollbars({
    //         className: Default.scrollbarTheme,
    //         sizeAutoCapable: true,
    //         scrollbars: {
    //             autoHide: Default.scrollbarAutoHide,
    //             clickScrolling: true
    //         }
    //     });
    // }

    // 
    window.start_load = function () {
        $('body').prepend('<di id="preloader2"></di>')
    }
    window.end_load = function () {
        $('#preloader2').fadeOut('fast', function () {
            $(this).remove();
        })
    }
    window.viewer_modal = function ($src = '') {
        start_load()
        var t = $src.split('.')
        t = t[1]
        if (t == 'mp4') {
            var view = $("<video src='" + $src + "' controls autoplay></video>")
        } else {
            var view = $("<img src='" + $src + "' />")
        }
        $('#viewer_modal .modal-content video,#viewer_modal .modal-content img').remove()
        $('#viewer_modal .modal-content').append(view)
        $('#viewer_modal').modal({
            show: true,
            backdrop: 'static',
            keyboard: false,
            focus: true
        })
        end_load()

    }
    window.uni_modal = function ($title = '', $url = '', $size = "", $isScrollable = 2) {
        start_load()
        $.ajax({
            url: $url,
            error: err => {
                console.log()
                alert("An error occured")
            },
            success: function (resp) {
                if (resp) {
                    $('#uni_modal .modal-title').html($title)
                    $('#uni_modal .modal-body').html(resp)

                    if ($isScrollable == 2) {
                        $('#uni_modal .modal-dialog').addClass('modal-dialog-scrollable')
                    } else {
                        $('#uni_modal .modal-dialog').removeClass('modal-dialog-scrollable')
                    }

                    if ($size != '') {
                        $('#uni_modal .modal-dialog').addClass($size)
                    } else {
                        $('#uni_modal .modal-dialog').removeAttr("class").addClass("modal-dialog modal-md")
                    }
                    $('#uni_modal').modal({
                        show: true,
                        backdrop: 'static',
                        keyboard: false,
                        focus: true
                    })
                    end_load()
                }
            }
        })
    }
    window._conf = function ($msg = '', $func = '', $params = []) {
        $('#confirm_modal #confirm').attr('onclick', $func + "(" + $params.join(',') + ")")
        $('#confirm_modal .modal-body').html($msg)
        $('#confirm_modal').modal('show')
    }
    window.alert_toast = function ($msg = 'TEST', $bg = 'success') {
        $('#alert_toast').removeClass('bg-success')
        $('#alert_toast').removeClass('bg-danger')
        $('#alert_toast').removeClass('bg-info')
        $('#alert_toast').removeClass('bg-warning')

        if ($bg == 'success')
            $('#alert_toast').addClass('bg-success')
        if ($bg == 'danger')
            $('#alert_toast').addClass('bg-danger')
        if ($bg == 'info')
            $('#alert_toast').addClass('bg-info')
        if ($bg == 'warning')
            $('#alert_toast').addClass('bg-warning')
        $('#alert_toast .toast-body').html($msg)
        $('#alert_toast').toast({
            delay: 3000
        }).toast('show');
    }
    $(document).ready(function () {
        $('#preloader').fadeOut('fast', function () {
            $(this).remove();
        })
    })

    // datepicker
    $('.datetimepicker').datetimepicker({
        format: 'Y/m/d H:i',
        startDate: '+3d'
    })

    // $('.dateonlypicker').datetimepicker({
    //     format: 'Y-m-d'
    // })

    // select2
    $('.select2').select2({
        placeholder: "Please select here",
        width: "100%"
    });

    // datatable
    var dtClass = $(".datatableClass")
        .on('error.dt', function (e, settings, techNote, message) {
            console.log('Dt Error: ', message);
        }).DataTable({
            "processing": true,
            "serverSide": false,
            "info": true,
            "autoWidth": false,
            oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' }
        })


    // top bar
    $('#manage_my_account').click(function () {
        let $this = $(this)
        let uuId = $this.attr("data-usersession");
        uni_modal("Manage Account", "manage_user.php?id=" + uuId + "&mtype=own")
    });

    // navbar
    $('.nav_collapse').click(function () {
        console.log($(this).attr('href'))
        $($(this).attr('href')).collapse()
    })
    $(".nav-" + pageNum).addClass('active')






    // ---------------------------------------------------------------
    //  home / dashboard
    // ---------------------------------------------------------------



    // requirments on dashboard
    if (document.querySelector("#requirements_dt") !== null) {

        // fetch all requirements
        let fetchAllReq = function () {
            let view = document.querySelector("#requirements_dt")
            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=fetch_all_requirments",
                dataType: "json",
                beforeSend: function () {
                    view.innerHTML = `<div class="d-flex justify-content-center">
                <div class="spinner-border text-success" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>`
                }
            }).done(function (response) {
                view.innerHTML = response.msg
                if (response.bool === true) {
                    $("#req_dt")
                        .on('error.dt', function (e, settings, techNote, message) {
                            console.log('Dt Error: ', message);
                        }).DataTable({
                            "processing": true,
                            "serverSide": false,
                            "info": true,
                            "autoWidth": false,
                            oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' }
                        });

                    // delete requirement
                    $("#req_dt tbody").on("click", ".delete_requirement", function () {
                        _conf("Are you sure to delete this requirement?", "delete_requirement", [$(this).attr('data-id')])
                    });
                }
            }).fail(function (jqXHR) {
                let response = JSON.parse(jqXHR.responseText)
                view.innerHTML = response.msg
            });

            //
        }
        fetchAllReq()

        // save requirements
        document.querySelector("#create-school-requirements").addEventListener("submit", function (ev) {

            ev.preventDefault();
            let form = $("#create-school-requirements")
            let formdata = form.serialize()
            let btn = $("#submit_requirement")
            let resp = document.querySelector("#response_req")

            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=save_requirements",
                dataType: "json",
                data: formdata,
                beforeSend: function () {
                    btn.prop("disabled", true)
                }
            }).done(function (response) {
                btn.prop("disabled", false)
                //
                resp.innerHTML = response.msg
                if (response.bool === true) {
                    fetchAllReq()
                    form[0].reset()
                }
            }).fail(function (jqXHR) {
                btn.prop("disabled", false)
                console.error(jqXHR)
                //
                let response = JSON.parse(jqXHR.responseText)
                resp.innerHTML = response.msg
            });
        });

    } //


    // fees structure on dashboard
    if (document.querySelector("#load_fees_dt") !== null) {

        // fetch all requirements
        let fetchAllReq = function () {
            let view = document.querySelector("#load_fees_dt")
            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=fetch_all_fees_structure",
                dataType: "json",
                beforeSend: function () {
                    view.innerHTML = `<div class="d-flex justify-content-center">
                <div class="spinner-border text-success" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>`
                }
            }).done(function (response) {
                view.innerHTML = response.msg
                if (response.bool === true) {
                    $("#fees_structure_dt")
                        .on('error.dt', function (e, settings, techNote, message) {
                            console.log('Dt Error: ', message);
                        }).DataTable({
                            "processing": true,
                            "serverSide": false,
                            "info": true,
                            "autoWidth": false,
                            oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' }
                        });

                    // delete requirement
                    $("#fees_structure_dt tbody").on("click", ".delete_fees_structure", function () {
                        _conf("Are you sure to delete this fees structure?", "delete_fees_structure", [$(this).attr('data-id')])
                    });

                    // edit 
                    $("#fees_structure_dt tbody").on("click", ".edit_fees_structure", function () {
                        let editId = $(this).data('id');
                        // let whichrow = $("#tr_fee_" + editId)
                        let sch_section = $.trim($("#sch_section" + editId).text())
                        let sch_amount = $.trim($("#sch_amount" + editId).text())

                        //
                        $("#sch_fees_id").val(editId)
                        // let schchk = $('input[name="section"]').val()
                        $(".sel_section_class").each(function () {
                            let chkval = $(this).val()
                            if (chkval == sch_section) $(this).prop('checked', true)
                        });
                        $("#sel_school_amount").val(sch_amount)

                    });
                }
            }).fail(function (jqXHR) {
                let response = JSON.parse(jqXHR.responseText)
                view.innerHTML = response.msg
            });

            //
        }
        fetchAllReq()

        // save requirements
        document.querySelector("#create-school-fees").addEventListener("submit", function (ev) {

            ev.preventDefault();
            let form = $("#create-school-fees")
            let formdata = form.serialize()
            let btn = $("#submit_fees")
            let resp = document.querySelector("#response_fees")

            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=save_school_fees",
                dataType: "json",
                data: formdata,
                beforeSend: function () {
                    btn.prop("disabled", true)
                }
            }).done(function (response) {
                btn.prop("disabled", false)
                //
                resp.innerHTML = response.msg
                if (response.bool === true) {
                    fetchAllReq()
                    form[0].reset()
                }
            }).fail(function (jqXHR) {
                btn.prop("disabled", false)
                console.error(jqXHR)
                //
                let response = JSON.parse(jqXHR.responseText)
                resp.innerHTML = response.msg
            });
        });

    }





    $('#manage-records').submit(function (e) {
        e.preventDefault()
        start_load()
        $.ajax({
            url: 'ajax.php?action=save_track',
            data: new FormData($(this)[0]),
            cache: false,
            contentType: false,
            processData: false,
            method: 'POST',
            type: 'POST',
            success: function (resp) {
                resp = JSON.parse(resp)
                if (resp.status == 1) {
                    alert_toast("Data successfully saved", 'success')
                    setTimeout(function () {
                        location.reload()
                    }, 800)

                }

            }
        })
    })
    $('#tracking_id').on('keypress', function (e) {
        if (e.which == 13) {
            get_person()
        }
    })
    $('#check').on('click', function (e) {
        get_person()
    })

    function get_person() {
        start_load()
        $.ajax({
            url: 'ajax.php?action=get_pdetails',
            method: "POST",
            data: {
                tracking_id: $('#tracking_id').val()
            },
            success: function (resp) {
                if (resp) {
                    resp = JSON.parse(resp)
                    if (resp.status == 1) {
                        $('#name').html(resp.name)
                        $('#address').html(resp.address)
                        $('[name="person_id"]').val(resp.id)
                        $('#details').show()
                        end_load()

                    } else if (resp.status == 2) {
                        alert_toast("Unknow tracking id.", 'danger');
                        end_load();
                    }
                }
            }
        })
    }


    // ---------------------------------------------------------------
    //  fees
    // ---------------------------------------------------------------

    $('.view_payment').click(function () {
        uni_modal("Payment Details", "view_payment.php?ef_id=" + $(this).attr('data-id') + "&pid=0", "mid-large")

    })
    $('#new_fees').click(function () {
        uni_modal("Enroll Student ", "manage_fee.php", "mid-large")

    })
    $('.edit_fees').click(function () {
        uni_modal("Manage Student's Enrollment Details", "manage_fee.php?id=" + $(this).attr('data-id'), "mid-large")

    })
    $('.delete_fees').click(function () {
        _conf("Are you sure to delete this fees ?", "delete_fees", [$(this).attr('data-id')])
    })






    // ---------------------------------------------------------------
    //  payments
    // ---------------------------------------------------------------

    $('#new_payment').click(function () {
        uni_modal("New Payment ", "manage_payment.php", "mid-large")

    })

    $('.view_payment').click(function () {
        uni_modal("Payment Details", "view_payment.php?ef_id=" + $(this).attr('data-ef_id') + "&pid=" + $(this).attr('data-id'), "mid-large")

    })
    $('.edit_payment').click(function () {
        uni_modal("Manage Payment", "manage_payment.php?id=" + $(this).attr('data-id'), "mid-large")

    })
    $('.delete_payment').click(function () {
        _conf("Are you sure to delete this payment ?", "delete_payment", [$(this).attr('data-id')])
    })

    function delete_payment($id) {
        start_load()
        $.ajax({
            url: 'ajax.php?action=delete_payment',
            method: 'POST',
            data: {
                id: $id
            },
            success: function (resp) {
                if (resp == 1) {
                    alert_toast("Data successfully deleted", 'success')
                    setTimeout(function () {
                        location.reload()
                    }, 1500)

                }
            }
        })
    }





    // ---------------------------------------------------------------
    //  classes
    // ---------------------------------------------------------------
    $('#new_class').click(function () {
        uni_modal("Add new class", "manage_classes.php", 'modal-md')

    })

    $('.edit_class').click(function () {
        let classinfoid = $(this).attr('data-id')
        let classnameid = $(this).attr('data-classinfo')
        uni_modal("Manage class details", "manage_classes.php?classnameid=" + classnameid + "&classinfoid=" + classinfoid, 'modal-md')

    })

    $('.delete_class').click(function () {
        _conf("Are you sure to delete this Class?", "delete_class", [$(this).attr('data-id')])
    })

    function delete_class($id) {
        start_load()
        $.ajax({
            url: 'ajax.php?action=delete_class',
            method: 'POST',
            data: {
                id: $id
            },
            success: function (resp) {
                if (resp == 1) {
                    alert_toast("Data successfully deleted", 'success')
                    setTimeout(function () {
                        location.reload()
                    }, 1500)

                }
            }
        })
    }







    // ---------------------------------------------------------------
    //  student
    // ---------------------------------------------------------------
    $('#new_student').click(function () {
        uni_modal("New Student ", "manage_student.php", "mid-large")

    })
    $('.edit_student').click(function () {
        uni_modal("Manage Student  Details", "manage_student.php?id=" + $(this).attr('data-id'), "mid-large")

    })
    $('.delete_student').click(function () {
        _conf("Are you sure to delete this Student ?", "delete_student", [$(this).attr('data-id')])
    })







    // ---------------------------------------------------------------
    //  payment report
    // ---------------------------------------------------------------
    $('#month').change(function () {
        location.replace('index.php?page=payments_report&month=' + $(this).val())
    })
    $('#print').click(function () {
        var _c = $('#report-list').clone();
        var ns = $('noscript').clone();
        ns.append(_c)
        var nw = window.open('', '_blank', 'width=900,height=600')
        nw.document.write('<p class="text-center"><b>Payment Report as of ' + printdt + '</b></p>')
        nw.document.write(ns.html())
        nw.document.close()
        nw.print()
        setTimeout(() => {
            nw.close()
        }, 500);
    })






    // ---------------------------------------------------------------
    //  users
    // ---------------------------------------------------------------

    $('#new_user').click(function () {
        uni_modal('New User', 'manage_user.php', 1)
    })
    $('.edit_user').click(function () {
        uni_modal('Edit User', 'manage_user.php?id=' + $(this).attr('data-id'))
    })
    $('.delete_user').click(function () {
        _conf("Are you sure to delete this user?", "delete_user", [$(this).attr('data-id')])
    });







    // ---------------------------------------------------------------
    //  teachers
    // ---------------------------------------------------------------
    $('#new_teacher').click(function () {
        uni_modal('New Teacher', 'manage_teachers.php', 2)
    })
    $('.edit_teacher').click(function () {
        uni_modal('Edit Teacher', 'manage_teachers.php?id=' + $(this).attr('data-id'), 2)
    })
    $('.delete_teacher').click(function () {
        _conf("Are you sure to delete this teacher?", "delete_teacher", [$(this).attr('data-id')])
    });



    // ---------------------------------------------------------------
    //  parents
    // ---------------------------------------------------------------
    $('#new_parent').click(function () {
        uni_modal('New Parent', 'manage_parents.php', 2)
    })
    $('.edit_parent').click(function () {
        uni_modal('Edit Parent', 'manage_parents.php?id=' + $(this).attr('data-id'), 2)
    })
    $('.delete_parent').click(function () {
        _conf("Are you sure to delete this parent information?", "delete_parent", [$(this).attr('data-id')])
    });



    // ---------------------------------------------------------------
    //  home
    // ---------------------------------------------------------------

})(jQuery);




/**
 * delete school fees structure
 * 
 * @param {number} $id
 */
function delete_fees_structure($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_fees_structure',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Fees structure successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)
            } else {
                alert_toast("Fees structure cannot be deleted since its already in use!", "danger");
                end_load()
            }
        }
    })
}



/**
 * delete requirement
 * 
 * @param {number} $id
 */
function delete_requirement($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_requirement',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Requirement successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)
            }
        }
    })
}


/**
 * delete student
 * 
 * @param {number} $id
 */
function delete_student($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_student',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Data successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)

            }
        }
    })
}


/**
 * delete fees
 * 
 * @param {number} $id 
 */
function delete_fees($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_fees',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Data successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)

            }
        }
    })
}


/**
 * delete user
 * 
 * @param {number} $id 
 */
function delete_user($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_user',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Data successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)

            }
        }
    })
}




