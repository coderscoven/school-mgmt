"use strict"

!(function ($) {

    // we'll handle datatable errors by ourselves
    $.fn.dataTable.ext.errMode = 'none';


    /**
     * scrollbaroverlay
     */
    if (typeof $.fn.overlayScrollbars !== 'undefined') {
        var Selector = {
            CONTROL_SIDEBAR: '#sidebar'
        };
        var Default = {
            scrollbarTheme: 'os-theme-dark',
            scrollbarAutoHide: 'l'
        };
        $(Selector.CONTROL_SIDEBAR).overlayScrollbars({
            className: Default.scrollbarTheme,
            sizeAutoCapable: true,
            scrollbars: {
                autoHide: Default.scrollbarAutoHide,
                clickScrolling: true
            }
        });
    }

    // 
    window.start_load = function () {
        $('body').prepend('<di id="preloader2"></di>')
    }
    window.end_load = function () {
        $('#preloader2').fadeOut('fast', function () {
            $(this).remove();
        })
    }
    window.viewer_modal = function ($src = '') {
        start_load()
        var t = $src.split('.')
        t = t[1]
        if (t == 'mp4') {
            var view = $("<video src='" + $src + "' controls autoplay></video>")
        } else {
            var view = $("<img src='" + $src + "' />")
        }
        $('#viewer_modal .modal-content video,#viewer_modal .modal-content img').remove()
        $('#viewer_modal .modal-content').append(view)
        $('#viewer_modal').modal({
            show: true,
            backdrop: 'static',
            keyboard: false,
            focus: true
        })
        end_load()

    }
    window.uni_modal = function ($title = '', $url = '', $size = "", $isScrollable = 2) {
        start_load()
        $.ajax({
            url: $url,
            error: err => {
                console.log()
                alert("An error occured")
            },
            success: function (resp) {
                if (resp) {
                    $('#uni_modal .modal-title').html($title)
                    $('#uni_modal .modal-body').html(resp)

                    if ($isScrollable == 2) {
                        $('#uni_modal .modal-dialog').addClass('modal-dialog-scrollable')
                    } else {
                        $('#uni_modal .modal-dialog').removeClass('modal-dialog-scrollable')
                    }

                    if ($size != '') {
                        $('#uni_modal .modal-dialog').addClass($size)
                    } else {
                        $('#uni_modal .modal-dialog').removeAttr("class").addClass("modal-dialog modal-md")
                    }
                    $('#uni_modal').modal({
                        show: true,
                        backdrop: 'static',
                        keyboard: false,
                        focus: true
                    })
                    end_load()
                }
            }
        })
    }
    window._conf = function ($msg = '', $func = '', $params = []) {
        $('#confirm_modal #confirm').attr('onclick', $func + "(" + $params.join(',') + ")")
        $('#confirm_modal .modal-body').html($msg)
        $('#confirm_modal').modal('show')
    }
    window.alert_toast = function ($msg = 'TEST', $bg = 'success') {
        $('#alert_toast').removeClass('bg-success')
        $('#alert_toast').removeClass('bg-danger')
        $('#alert_toast').removeClass('bg-info')
        $('#alert_toast').removeClass('bg-warning')

        if ($bg == 'success')
            $('#alert_toast').addClass('bg-success')
        if ($bg == 'danger')
            $('#alert_toast').addClass('bg-danger')
        if ($bg == 'info')
            $('#alert_toast').addClass('bg-info')
        if ($bg == 'warning')
            $('#alert_toast').addClass('bg-warning')
        $('#alert_toast .toast-body').html($msg)
        $('#alert_toast').toast({
            delay: 3000
        }).toast('show');
    }

    /**
     * ajax handle form submissions
     * @param {*} urlpath 
     * @param {*} formdata 
     * @param {*} formid 
     * @param {*} btnid 
     */
    let func_form_requests = function (urlpath, formdata, formid, btnid) {

        let url = "ajax.php?action=" + urlpath
        $.ajax({
            url: url,
            method: "post",
            data: formdata,
            dataType: "json",
            beforeSend: function () {
                if (btnid != "") btnid.prop("disabled", true)
            }
        }).done(function (response) {
            let msg = response.msg
            let bool = response.bool
            if (btnid != "") btnid.prop("disabled", false)
            //
            if (bool) {
                alert_toast(msg, "success")
                if (formid == "") {
                    formid[0].reset()
                }
            }
            else alert_toast(msg, "danger")

        }).fail(function (jqXHR) {
            if (btnid != "") btnid.prop("disabled", false)
            let response = JSON.parse(jqXHR.responseText)
            alert_toast(response.msg, "danger")
        });
    }


    /**
     * ajax handle normal events apart from form submissions
     * @param {*} urlpath 
     * @param {*} formdata 
     */
    let func_event_requests = function (urlpath, formdata, view) {

        let url = "ajax.php?action=" + urlpath
        $.ajax({
            url: url,
            method: "post",
            data: formdata,
            success: function (response) {
                view.html(response)
            },
            error: function (jqXHR, textStatus, errorThrown) {
                view.html(jqXHR)
            }
        });
    }

    // preloader
    $(document).ready(function () {
        $('#preloader').fadeOut('fast', function () {
            $(this).remove();
        })
    })

    // datepicker
    $('.datetimepicker').datetimepicker({
        format: 'Y/m/d H:i',
        startDate: '+3d'
    });
    // year only
    $('.yearonly').datetimepicker({
        format: 'Y'
    });

    // $('.dateonlypicker').datetimepicker({
    //     format: 'Y-m-d'
    // })

    // select2
    $('.select2').select2({
        placeholder: "--- select ---",
        width: "100%"
    });

    // datatable
    var dtClass = $(".datatableClass")
        .on('error.dt', function (e, settings, techNote, message) {
            console.log('Dt Error: ', message);
        }).DataTable({
            "processing": true,
            "serverSide": false,
            "info": true,
            "autoWidth": false,
            oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' }
        })


    // top bar
    $('#manage_my_account').click(function () {
        let $this = $(this)
        let uuId = $this.attr("data-usersession");
        uni_modal("Manage Account", "manage_user.php?id=" + uuId + "&mtype=own")
    });

    // navbar
    $('.nav_collapse').click(function () {
        console.log($(this).attr('href'))
        $($(this).attr('href')).collapse()
    })
    $(".nav-" + pageNum).addClass('active')






    // ---------------------------------------------------------------
    //  home / dashboard
    // ---------------------------------------------------------------

    //
    let checkschooltermisset = function () {
        start_load()
        $.ajax({
            url: 'ajax.php?action=check_if_school_is_init',
            method: 'POST',
            dataType: "json",
            success: function (response) {
                end_load()
                if (response.bool === false) {
                    uni_modal(response.msg, "manage_school_term.php", "mid-large")
                } else
                    console.log(response.msg)
            },
            error: function (jqXHR) {
                end_load()
            }
        });
    }
    checkschooltermisset()

    // set school term
    if (document.querySelector("#set_school_term") !== null) {
        document.querySelector("#set_school_term").addEventListener("click", function (ev) {
            ev.preventDefault();
            uni_modal("School Term", "manage_school_term.php", "mid-large")
        });
    }



    // requirments on dashboard
    if (document.querySelector("#requirements_dt") !== null) {

        // fetch all requirements
        let fetchAllReq = function () {
            let view = document.querySelector("#requirements_dt")
            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=fetch_all_requirments",
                dataType: "json",
                beforeSend: function () {
                    view.innerHTML = `<div class="d-flex justify-content-center">
                <div class="spinner-border text-success" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>`
                }
            }).done(function (response) {
                view.innerHTML = response.msg
                if (response.bool === true) {
                    $("#req_dt")
                        .on('error.dt', function (e, settings, techNote, message) {
                            console.log('Dt Error: ', message);
                        }).DataTable({
                            "processing": true,
                            "serverSide": false,
                            "info": true,
                            "autoWidth": false,
                            oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' }
                        });

                    // delete requirement
                    $("#req_dt tbody").on("click", ".delete_requirement", function () {
                        _conf("Are you sure to delete this requirement?", "delete_requirement", [$(this).attr('data-id')])
                    });
                }
            }).fail(function (jqXHR) {
                let response = JSON.parse(jqXHR.responseText)
                view.innerHTML = response.msg
            });

            //
        }
        fetchAllReq()

        // save requirements
        document.querySelector("#create-school-requirements").addEventListener("submit", function (ev) {

            ev.preventDefault();
            let form = $("#create-school-requirements")
            let formdata = form.serialize()
            let btn = $("#submit_requirement")
            let resp = document.querySelector("#response_req")

            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=save_requirements",
                dataType: "json",
                data: formdata,
                beforeSend: function () {
                    btn.prop("disabled", true)
                }
            }).done(function (response) {
                btn.prop("disabled", false)
                //
                resp.innerHTML = response.msg
                if (response.bool === true) {
                    fetchAllReq()
                    form[0].reset()
                }
            }).fail(function (jqXHR) {
                btn.prop("disabled", false)
                console.error(jqXHR)
                //
                let response = JSON.parse(jqXHR.responseText)
                resp.innerHTML = response.msg
            });
        });

    } //


    // fees structure on dashboard
    if (document.querySelector("#load_fees_dt") !== null) {

        // fetch all requirements
        let fetchAllReq = function () {
            let view = document.querySelector("#load_fees_dt")
            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=fetch_all_fees_structure",
                dataType: "json",
                beforeSend: function () {
                    view.innerHTML = `<div class="d-flex justify-content-center">
                <div class="spinner-border text-success" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>`
                }
            }).done(function (response) {
                view.innerHTML = response.msg
                if (response.bool === true) {
                    $("#fees_structure_dt")
                        .on('error.dt', function (e, settings, techNote, message) {
                            console.log('Dt Error: ', message);
                        }).DataTable({
                            "processing": true,
                            "serverSide": false,
                            "info": true,
                            "autoWidth": false,
                            oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' }
                        });

                    // delete requirement
                    $("#fees_structure_dt tbody").on("click", ".delete_fees_structure", function () {
                        _conf("Are you sure to delete this fees structure?", "delete_fees_structure", [$(this).attr('data-id')])
                    });

                    // edit 
                    $("#fees_structure_dt tbody").on("click", ".edit_fees_structure", function () {
                        let editId = $(this).data('id');
                        // let whichrow = $("#tr_fee_" + editId)
                        let sch_section = $.trim($("#sch_section" + editId).text())
                        let sch_amount = $.trim($("#sch_amount" + editId).text())

                        //
                        $("#sch_fees_id").val(editId)
                        // let schchk = $('input[name="section"]').val()
                        $(".sel_section_class").each(function () {
                            let chkval = $(this).val()
                            if (chkval == sch_section) $(this).prop('checked', true)
                        });
                        $("#sel_school_amount").val(sch_amount)

                    });
                }
            }).fail(function (jqXHR) {
                let response = JSON.parse(jqXHR.responseText)
                view.innerHTML = response.msg
            });

            //
        }
        fetchAllReq()

        // save requirements
        document.querySelector("#create-school-fees").addEventListener("submit", function (ev) {

            ev.preventDefault();
            let form = $("#create-school-fees")
            let formdata = form.serialize()
            let btn = $("#submit_fees")
            let resp = document.querySelector("#response_fees")

            let jqxhr = $.ajax({
                method: "post",
                url: "ajax.php?action=save_school_fees",
                dataType: "json",
                data: formdata,
                beforeSend: function () {
                    btn.prop("disabled", true)
                }
            }).done(function (response) {
                btn.prop("disabled", false)
                //
                resp.innerHTML = response.msg
                if (response.bool === true) {
                    fetchAllReq()
                    form[0].reset()
                }
            }).fail(function (jqXHR) {
                btn.prop("disabled", false)
                console.error(jqXHR)
                //
                let response = JSON.parse(jqXHR.responseText)
                resp.innerHTML = response.msg
            });
        });

    }





    $('#manage-records').submit(function (e) {
        e.preventDefault()
        start_load()
        $.ajax({
            url: 'ajax.php?action=save_track',
            data: new FormData($(this)[0]),
            cache: false,
            contentType: false,
            processData: false,
            method: 'POST',
            type: 'POST',
            success: function (resp) {
                resp = JSON.parse(resp)
                if (resp.status == 1) {
                    alert_toast("Data successfully saved", 'success')
                    setTimeout(function () {
                        location.reload()
                    }, 800)

                }

            }
        })
    })
    $('#tracking_id').on('keypress', function (e) {
        if (e.which == 13) {
            get_person()
        }
    })
    $('#check').on('click', function (e) {
        get_person()
    })

    function get_person() {
        start_load()
        $.ajax({
            url: 'ajax.php?action=get_pdetails',
            method: "POST",
            data: {
                tracking_id: $('#tracking_id').val()
            },
            success: function (resp) {
                if (resp) {
                    resp = JSON.parse(resp)
                    if (resp.status == 1) {
                        $('#name').html(resp.name)
                        $('#address').html(resp.address)
                        $('[name="person_id"]').val(resp.id)
                        $('#details').show()
                        end_load()

                    } else if (resp.status == 2) {
                        alert_toast("Unknow tracking id.", 'danger');
                        end_load();
                    }
                }
            }
        })
    }


    // ---------------------------------------------------------------
    //  fees
    // ---------------------------------------------------------------

    $('.view_payment').click(function () {
        uni_modal("Payment Details", "view_payment.php?ef_id=" + $(this).attr('data-id') + "&pid=0", "mid-large")

    })

    $('#new_fees').click(function () {
        uni_modal("Enroll Student ", "manage_fee.php", "mid-large")
    })

    $('#payments_dt tbody').on('click', '.edit_fees', function () {
        uni_modal("Manage Student's Enrollment Details", "manage_fee.php?id=" + $(this).attr('data-id'), "mid-large")
    })

    $('#payments_dt tbody').on('click', '.delete_enrollment_and_fees', function () {
        _conf("Are you sure to delete this enrollment?", "delete_enrollment_and_fees", [$(this).attr('data-id')])
    })






    // ---------------------------------------------------------------
    //  payments
    // ---------------------------------------------------------------

    $('#new_payment').click(function () {
        uni_modal("New Payment ", "manage_payment.php", "mid-large")
    });

    $('.view_payment').click(function () {
        let act = $(this).attr("data-act");
        switch (act) {
            case "f": // fees
                end_load()
                uni_modal("Payment Details", "view_payment.php?ef_id=" + $(this).attr('data-id') + "&pid=0", "mid-large")
                break;

            case "p": // payments
                end_load()
                uni_modal("Payment Details", "view_payment.php?ef_id=" + $(this).attr('data-ef_id') + "&pid=" + $(this).attr('data-id'), "mid-large");
                break;
        }
    });

    $('.edit_payment').click(function () {
        uni_modal("Manage Payment", "manage_payment.php?id=" + $(this).attr('data-id'), "mid-large")
    });

    $('.delete_payment').click(function () {
        _conf("Are you sure to delete this payment ?", "delete_payment", [$(this).attr('data-id')])
    });



    // ---------------------------------------------------------------
    //  classes
    // ---------------------------------------------------------------
    $('#new_class').click(function () {
        uni_modal("Add new class", "manage_classes.php", 'modal-md')

    })

    $('.edit_class').click(function () {
        let classinfoid = $(this).attr('data-id')
        let classnameid = $(this).attr('data-classinfo')
        uni_modal("Manage class details", "manage_classes.php?classnameid=" + classnameid + "&classinfoid=" + classinfoid, 'modal-md')

    })

    $('.delete_class').click(function () {
        _conf("Are you sure to delete this Class?", "delete_class", [$(this).attr('data-id')])
    })

    function delete_class($id) {
        start_load()
        $.ajax({
            url: 'ajax.php?action=delete_class',
            method: 'POST',
            data: {
                id: $id
            },
            success: function (resp) {
                if (resp == 1) {
                    alert_toast("Data successfully deleted", 'success')
                    setTimeout(function () {
                        location.reload()
                    }, 1500)

                }
            }
        })
    }







    // ---------------------------------------------------------------
    //  student
    // ---------------------------------------------------------------
    $('#new_student').click(function () {
        uni_modal("New Student ", "manage_student.php", "mid-large")

    })
    $('.edit_student').click(function () {
        uni_modal("Manage Student  Details", "manage_student.php?id=" + $(this).attr('data-id'), "mid-large")

    })
    // print student information
    $('#student_list_dt tbody').on('click', '.print_student', function () {
        uni_modal("Print Student Information", "print-view.php?studid=" + $(this).attr('data-id'), "mid-large")
    });

    $('.delete_student').click(function () {
        _conf("Are you sure to delete this Student ?", "delete_student", [$(this).attr('data-id')])
    })


    //
    // requirements report
    // 
    if (document.querySelector("#rprt_requirement_dataform") !== null) {
        document.querySelector("#rprt_requirement_dataform").addEventListener("submit", function (ev) {
            ev.preventDefault()
            let form = $("#rprt_requirement_dataform")
            let btn = $("#rprt_requirement_btn")
            let view = $("#load_requirements_report_cnt")

            $.ajax({
                url: "ajax.php?action=requirements_reports",
                method: "post",
                data: form.serialize(),
                dataType: "json",
                beforeSend: function () {
                    btn.prop("disabled", true)
                }
            }).done(function (response) {
                btn.prop("disabled", false)
                //
                view.html(response.msg)

            }).fail(function (jqXHR, errorStatus, errorThrown) {
                btn.prop("disabled", false)
                let response = JSON.parse(jqXHR.responseText)
                view.html(response.msg)
            });
        });
    }


    //
    //  student reports
    //
    if (document.querySelector("#students_report_dataform") !== null) {

        document.querySelector("#students_report_dataform").addEventListener("submit", function (ev) {
            ev.preventDefault()
            let form = $("#students_report_dataform")
            let btn = $("#students_report_btn")
            let view = $("#load_student_report_results")

            $.ajax({
                url: "ajax.php?action=students_reports",
                method: "post",
                data: form.serialize(),
                dataType: "json",
                beforeSend: function () {
                    btn.prop("disabled", true)
                }
            }).done(function (response) {
                btn.prop("disabled", false)
                //
                view.html(response.msg)

            }).fail(function (jqXHR) {
                btn.prop("disabled", false)
                let response = JSON.parse(jqXHR.responseText)
                view.html(response.msg)
            });
        });
    }





    // ---------------------------------------------------------------
    //  payment report
    // ---------------------------------------------------------------
    $('#month').change(function () {
        let params = { 'page': 'payments_report', 'month': $(this).val() }
        let url = jQuery.param(params)
        location.replace('index.php?' + url)
    });

    $('#print').click(function () {
        var _c = $('#report-list').clone();
        var ns = $('noscript').clone();
        ns.append(_c)
        var nw = window.open('', '_blank', 'width=900,height=600')
        nw.document.write('<p class="text-center"><b>Payment Report as of ' + printdt + '</b></p>')
        nw.document.write(ns.html())
        nw.document.close()
        nw.print()
        setTimeout(() => {
            nw.close()
        }, 500);
    });


    // payment reports
    if (document.querySelector('#payment_report_dataform') !== null) {

        // var title = '<p class="text-center"><b>Payment Report as of ' + printdt + '</b></p>';
        let view = document.querySelector("#payment_rprt_cnt")

        let payment_rptdt = function (title, msgtop) {
            $('#report-list').DataTable({

                "paging": true,
                "lengthChange": false,
                "searching": false,
                "ordering": false,
                "info": true,
                "autoWidth": true,
                oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' },
                "dom": '<"row mb-3"<"col-12"B>>' + '<"row"<"col-12"t>>' + '<"row my-3"<"col-md-4"i><"col-md-8"p>>',
                buttons: [{
                    extend: 'excelHtml5',
                    text: '<i class="fas fa-file-excel"></i> Export to Excel',
                    className: 'btn btn-success btn-sm',
                    title: title,
                    messageTop: msgtop,
                    exportOptions: {
                        columns: ":visible"
                    }
                },
                // {
                //     extend: 'pdfHtml5',
                //     text: ' <i class="fas fa-file-pdf"></i> Export to PDF',
                //     className: 'btn btn-danger btn-sm',
                //     title: title,
                //     messageTop: msgtop,
                //     customize: function (doc) {
                //         doc.content.forEach(function (item) {
                //             if (item.table) {
                //                 item.table.widths = ['5%', '15%', '20%', '15%', '30%', '15%']
                //             }
                //         })
                //     },
                // },
                {
                    extend: 'print',
                    text: '<i class="fas fa-print"></i> Print',
                    className: 'btn btn-info btn-sm',
                    title: title,
                    messageTop: msgtop,
                    autoPrint: false,
                    customize: function (win) {

                        // general table
                        $(win.document.body)
                            .css({ 'font-size': '10pt', 'background': '#ffffff' });

                        // outer border
                        $(win.document.body)
                            .find('table')
                            .css("border", "1px solid #161a1d");

                        // inner border - 1
                        $(win.document.body)
                            .find('table th')
                            .css("border", "1px solid #161a1d");

                        // inner border - 2
                        $(win.document.body)
                            .find('table td')
                            .css("border", "1px solid #161a1d");

                        // table title
                        $(win.document.body)
                            .find('h1')
                            .addClass('text-center h2 font-weight-bold');


                        // table header
                        $(win.document.body)
                            .find('table thead')
                            .addClass('text-black font-weight-bold text-uppercase small-90');
                        //.css('font-size', 'inherit');

                        // table body
                        $(win.document.body)
                            .find('table tbody')
                            .addClass('bg-white text-dark');
                        //
                    }
                }
                ]
            });
        }

        // load payment report dt
        let paymentreportfetch = function () {
            let form = $("#payment_report_dataform")
            var filterDataArray = [];
            $('input[name="rprt_payment_date"].rprt-payment-filter, .rprt-payment-filter option:selected').each(function () {
                var dtType = $(this).attr("data-type");
                var dtValue = $(this).val();

                if (dtType == "dt_student") {
                    document.querySelector("#student_sel").value = dtValue
                }
                if (dtType == "dt_school_term") {
                    document.querySelector("#rpt_term").value = dtValue
                }
                if (dtType == "dt_date_range") {
                    document.querySelector("#rpt_date").value = dtValue
                }
                filterDataArray.push({
                    "type": dtType,
                    "value": dtValue
                });
            });

            $.ajax({
                method: "post",
                url: "ajax.php?action=payments_report",
                beforeSend: function () {
                    view.innerHTML = `<div class="text-center">
                    <div class="spinner-border text-info" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                  </div>`
                },
                data: {
                    'filter_data': filterDataArray,
                    'student_sel': document.querySelector("#student_sel").value,
                    'rpt_term': document.querySelector("#rpt_term").value,
                    'rpt_date': document.querySelector("#rpt_date").value
                },
                cache: false,
                dataType: "json"
            }).done(function (response) {
                view.innerHTML = response.view
                payment_rptdt(response.title, response.messagetop)
            }).fail(function (jqXHR, errorStatus, errorThrown) {
                view.innerHTML = jqXHR.responseText
            });
        }
        paymentreportfetch()


        $(".rprt-payment-filter").on("change", function () {
            paymentreportfetch();
        });

        //
        $(".monthpicker").datepicker({
            dateFormat: 'yy-mm'
        });

        $("#rprt_payment_date").datepicker({
            dateFormat: "yy-mm-dd"
        }).attr("placeholder", "--- select date ---");

        // $("#rprt_payment_date").daterangepicker({
        //     timePicker: false,
        //     locale: {
        //         format: 'YYYY-MM-DD'
        //     },
        //     showDropdowns: true,
        //     singleDatePicker: true

        // },
        //     function (start, end) {
        //         document.querySelector("#rp_start_date").value = start.format('YYYY-MM-DD')
        //         document.querySelector("#rp_end_date").value = end.format('YYYY-MM-DD')
        //     })
        //     .val('')
        //     .attr("placeholder", "--- select date ---");

        // submit payment report filter
        document.querySelector("#payment_report_dataform").addEventListener("submit", function (ev) {

            ev.preventDefault()

            let form = $("#payment_report_dataform")
            let btn = $("#rprt_submit_btn")

            $.ajax({
                method: "post",
                url: "ajax.php?action=",
                data: form.serialize(),
                beforeSend: function () {
                    btn.prop("disabled", true)
                },
                cache: false
            }).done(function (response) {
                btn.prop("disabled", false)
                view.innerHTML = response
            }).fail(function (jqXHR, errorStatus, errorThrown) {
                btn.prop("disabled", false)
                view.innerHTML = errorThrown
            });

        })

    }






    // ---------------------------------------------------------------
    //  users
    // ---------------------------------------------------------------

    $('#new_user').click(function () {
        uni_modal('New User', 'manage_user.php', 1)
    })
    $('.edit_user').click(function () {
        uni_modal('Edit User', 'manage_user.php?id=' + $(this).attr('data-id'))
    })
    $('.delete_user').click(function () {
        _conf("Are you sure to delete this user?", "delete_user", [$(this).attr('data-id')])
    });

    // assign credentials
    $('#assign_user_credentials').click(function () {
        uni_modal('Assign User Credentials', 'manage_user_credentials.php', 1)
    })





    // ---------------------------------------------------------------
    //  teachers
    // ---------------------------------------------------------------
    $('#new_teacher').click(function () {
        uni_modal('New Teacher', 'manage_teachers.php', 2)
    })
    $('.edit_teacher').click(function () {
        uni_modal('Edit Teacher', 'manage_teachers.php?id=' + $(this).attr('data-id'), 2)
    })
    $('.delete_teacher').click(function () {
        _conf("Are you sure to delete this teacher?", "delete_teacher", [$(this).attr('data-id')])
    });



    // ---------------------------------------------------------------
    //  parents
    // ---------------------------------------------------------------
    $('#new_parent').click(function () {
        uni_modal('New Parent', 'manage_parents.php', 2)
    })
    $('.edit_parent').click(function () {
        uni_modal('Edit Parent', 'manage_parents.php?id=' + $(this).attr('data-id'), 2)
    })
    $('.delete_parent').click(function () {
        _conf("Are you sure to delete this parent information?", "delete_parent", [$(this).attr('data-id')])
    });


    // ---------------------------------------------------------------
    //  student bringing requirements on reporting day
    // ---------------------------------------------------------------
    if (document.querySelector("#save_stud_requirements") !== null) {

        // load class
        var studid = document.querySelector("#edit_req_student_id").value
        // func_event_requests("load_class_student", { studentid: studid }, $("#load_class_student"))

        $.ajax({
            url: "ajax.php?action=load_class_student",
            method: "post",
            data: { 'studentid': studid },
            success: function (response) {
                $("#class_container").html(response)
                //
                if (document.querySelector("#stud_req_sel_class") !== null) {
                    document.querySelector("#stud_req_sel_class").addEventListener("change", function (ev) {
                        let class_id = document.querySelector("#stud_req_sel_class").value
                        func_event_requests("load_students_based_on_sel_class", { class_id: class_id }, $("#load_students_list_for_sel"))
                        func_event_requests("load_requirements_based_on_sel_class", { class_id: class_id }, $("#load_student_requirements_cnt"))
                    });
                }

            },
            error: function (jqXHR, textStatus, errorThrown) {
                $("#class_container").html(jqXHR)
            }
        });


        document.querySelector("#save_stud_requirements").addEventListener("submit", function (ev) {
            ev.preventDefault();
            let formid = $("#save_stud_requirements")
            let btn = $("#stud_req_submit_btn")
            func_form_requests("save_student_requirements", formid.serialize(), formid, btn)
        });

        // select2
        // $('#stud_req_sel_student').select2({
        //     placeholder: "--- select ---",
        //     width: "100%"
        // }).on("change", function (ev) {
        //     let stud_id = $("#stud_req_sel_student option:selected").val()
        //     document.querySelector("#edit_req_student_id").value = stud_id
        //     func_event_requests("load_student_requirements", { studentid: stud_id }, $("#load_student_requirements_cnt"))
        // });

    } //



    /***
     * payment history
     */
    if (document.querySelector("#payment_hist_dt") !== null) {

        // var dtClass = $(".datatableClass")
        //     .on('error.dt', function (e, settings, techNote, message) {
        //         console.log('Dt Error: ', message);
        //     }).DataTable({
        //         "processing": true,
        //         "serverSide": false,
        //         "info": true,
        //         "autoWidth": false,
        //         oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' }
        //     })

        $('#payment_hist_dt').on('error.dt', function (e, settings, techNote, message) {
            console.log('Dt Error: ', message);
        }).DataTable({
            "processing": true,
            "paging": true,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            oLanguage: { sProcessing: '<div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div>' },
            "footerCallback": function (row, data, start, end, display) {
                var api = this.api(), data;

                // Remove the formatting to get integer data for summation
                var intVal = function (i) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '') * 1 :
                        typeof i === 'number' ?
                            i : 0;
                };

                //add commas
                var addCommas = function (nStr) {
                    nStr += '';
                    var x = nStr.split('.');
                    var x1 = x[0];
                    var x2 = x.length > 1 ? '.' + x[1] : '';
                    var rgx = /(\d+)(\d{3})/;
                    while (rgx.test(x1)) {
                        x1 = x1.replace(rgx, '$1' + ',' + '$2');
                    }
                    return x1 + x2;
                };

                // Total over all pages
                var total = api
                    .column(6)
                    .data()
                    .reduce(function (a, b) {
                        var getTotal = intVal(a) + intVal(b);
                        return addCommas(getTotal);
                    }, 0);

                // Total over this page
                var pageTotal = api
                    .column(6, { page: 'current' })
                    .data()
                    .reduce(function (a, b) {
                        var getThis = intVal(a) + intVal(b);
                        return addCommas(getThis);
                    }, 0);


                // Update footer
                $(api.column(6).footer()).html(
                    pageTotal
                );
            }
        });
    }



    // student roll call
    if (document.querySelector("#student_roll_call_dtfrm") !== null) {

        document.querySelector("#student_roll_call_dtfrm").addEventListener("submit", function (ev) {
            ev.preventDefault()
            let btnid = $("#roll_call_loadbtn")
            let formid = $("#student_roll_call_dtfrm")
            let view = document.querySelector("#load_student_roll_call")

            document.querySelector("#rc_feedback").innerHTML = ''

            $.ajax({
                url: "ajax.php?action=load_student_roll_call",
                method: "post",
                data: formid.serialize(),
                dataType: "json",
                beforeSend: function () {
                    btnid.prop("disabled", true)
                }
            }).done(function (response) {

                btnid.prop("disabled", false)
                view.innerHTML = response.msg

                if (response.bool === true) {
                    submit_roll_call()
                }

            }).fail(function (jqXHR) {
                btnid.prop("disabled", false)
                let response = JSON.parse(jqXHR.responseText)
                view.innerHTML = response.msg
            });
        });


    }


    // roll call report
    if (document.querySelector("#student_roll_call_report_dtfrm") !== null) {

        $("#roll_call_report_date").datepicker({
            dateFormat: "yy-mm-dd"
        })

        document.querySelector("#student_roll_call_report_dtfrm").addEventListener("submit", function (ev) {
            ev.preventDefault()
            let btnid = $("#roll_call_loadbtn")
            let formid = $("#student_roll_call_report_dtfrm")
            let view = document.querySelector("#load_student_roll_call_report")

            document.querySelector("#rc_feedback").innerHTML = ''

            $.ajax({
                url: "ajax.php?action=student_roll_call_report",
                method: "post",
                data: formid.serialize(),
                dataType: "json",
                beforeSend: function () {
                    btnid.prop("disabled", true)
                }
            }).done(function (response) {

                btnid.prop("disabled", false)
                view.innerHTML = response.msg

                if (response.bool === true) {
                    submit_roll_call()
                }

            }).fail(function (jqXHR) {
                btnid.prop("disabled", false)
                let response = JSON.parse(jqXHR.responseText)
                view.innerHTML = response.msg
            });
        });

    }



    /**
     * submit roll call information func
     */
    function submit_roll_call() {

        document.querySelector("#submit_roll_call_info_dtfrm").addEventListener("submit", function (ev) {

            ev.preventDefault()

            let btnid = $("#submit_roll_call_btn")
            let formid = $("#submit_roll_call_info_dtfrm")

            $.ajax({
                url: "ajax.php?action=save_roll_call_information",
                method: "post",
                data: formid.serialize(),
                dataType: "json",
                beforeSend: function () {
                    btnid.prop("disabled", true)
                }
            }).done(function (response) {

                btnid.prop("disabled", false)
                // alert_toast(response.msg, "success")
                document.querySelector("#rc_feedback").innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert"><p class="my-1">${response.msg}</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>`

            }).fail(function (jqXHR, textStatus, errorThrown) {
                btnid.prop("disabled", false)
                let response = JSON.parse(jqXHR.responseText)
                document.querySelector("#rc_feedback").innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert"><p class="my-1">${response.msg}</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>`
            });
        });
    } //


    /**
     * teacher details report
     */
    if (document.querySelector("#teacher_info_report_dataform") !== null) {

        let view = document.querySelector("#load_teacher_report_results")

        document.querySelector("#teacher_info_report_dataform").addEventListener("submit", function (ev) {

            ev.preventDefault()

            let btnid = $("#teacher_info_report_btn")
            let formid = $("#teacher_info_report_dataform")

            $.ajax({
                url: "ajax.php?action=teacher_info_report",
                method: "post",
                data: formid.serialize(),
                dataType: "json",
                beforeSend: function () {
                    btnid.prop("disabled", true)
                }
            }).done(function (response) {

                btnid.prop("disabled", false)
                view.innerHTML = response.msg

            }).fail(function (jqXHR, textStatus, errorThrown) {
                btnid.prop("disabled", false)
                let response = JSON.parse(jqXHR.responseText)
                view.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert"><p class="my-1">${response.msg}</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>`
            });
        });
    }

})(jQuery);


/**
 * delete payment
 * 
 * @param {number} $id 
 */
function delete_payment($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_payment',
        method: 'POST',
        data: {
            id: $id
        },
        dataType: "json",
        success: function (response) {
            if (response.bool === true) {
                alert_toast(response.msg, 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)
            } else
                alert_toast(response.msg, "danger")
        },
        error: function (jqXHR) {
            let response = JSON.parse(jqXHR.responseText)
            alert_toast(response.msg, "danger")
        }
    });
}


/**
 * delete school fees structure
 * 
 * @param {number} $id
 */
function delete_fees_structure($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_fees_structure',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Fees structure successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)
            } else {
                alert_toast("Fees structure cannot be deleted since its already in use!", "danger");
                end_load()
            }
        }
    })
}



/**
 * delete requirement
 * 
 * @param {number} $id
 */
function delete_requirement($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_requirement',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Requirement successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)
            }
        }
    })
}


/**
 * delete student
 * 
 * @param {number} $id
 */
function delete_student($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_student',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Data successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)

            }
        }
    })
}


/**
 * delete fees and enrollment
 * 
 * @param {number} $id 
 */
function delete_enrollment_and_fees($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_enrollment_and_fees',
        method: 'POST',
        data: {
            id: $id
        },
        dataType: "json",
        success: function (response) {
            if (response.bool === true) {
                alert_toast(response.msg, 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)

            } else {
                end_load()
                alert_toast(response.msg, 'danger')
            }
        }
    })
}


/**
 * delete user
 * 
 * @param {number} $id 
 */
function delete_user($id) {
    start_load()
    $.ajax({
        url: 'ajax.php?action=delete_user',
        method: 'POST',
        data: {
            id: $id
        },
        success: function (resp) {
            if (resp == 1) {
                alert_toast("Data successfully deleted", 'success')
                setTimeout(function () {
                    location.reload()
                }, 1500)

            }
        }
    })
}




